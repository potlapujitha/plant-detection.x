<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plant Scanner</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>Plant Scanner</h2>
    <video id="camera" autoplay playsinline></video>
    <button id="captureBtn">Capture</button>
    <canvas id="snapshot" style="display:none;"></canvas>

    <h3>Or Upload an Image</h3>
    <input type="file" id="imageInput" accept="image/*" />
    <button id="detectBtn">Detect</button>

    <h3>Result</h3>
    <pre id="result">No detection yet</pre>

    <h3>Your Location</h3>
    <pre id="location">Detecting...</pre>
  </div>

  <script>
    // Access camera
    const video = document.getElementById("camera");
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => console.error("Camera error:", err));

    // Capture photo
    document.getElementById("captureBtn").addEventListener("click", () => {
      const canvas = document.getElementById("snapshot");
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => sendToServer(blob), "image/jpeg");
    });

    // Upload file manually
    document.getElementById("detectBtn").addEventListener("click", async () => {
      const file = document.getElementById("imageInput").files[0];
      if (!file) return alert("Select an image first!");
      sendToServer(file);
    });

    async function sendToServer(imageBlob) {
      const fd = new FormData();
      fd.append("image", imageBlob);
      const res = await fetch("http://localhost:3000/api/detect", { method: "POST", body: fd });
      const json = await res.json();
      document.getElementById("result").textContent = JSON.stringify(json, null, 2);
    }

    // Get location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          document.getElementById("location").textContent = `Latitude: ${latitude}\nLongitude: ${longitude}`;
        },
        err => {
          document.getElementById("location").textContent = "Location access denied";
        }
      );
    } else {
      document.getElementById("location").textContent = "Geolocation not supported";
    }
  </script>
</body>
</html>
